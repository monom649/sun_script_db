<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æœ¬è©³ç´° - ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTVå°æœ¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆÎ²ç‰ˆï¼‰</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸŒ ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTVå°æœ¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆÎ²ç‰ˆï¼‰</h1>
            <p class="subtitle">å°æœ¬è©³ç´°ãƒšãƒ¼ã‚¸</p>
            <div style="margin-top: 20px;">
                <a href="index.html" style="background: var(--accent-color); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold;">â† æ¤œç´¢ã«æˆ»ã‚‹</a>
            </div>
        </header>

        <!-- å°æœ¬æƒ…å ± -->
        <div class="script-info-section">
            <div class="script-info-card">
                <div id="script-title" class="script-title">èª­ã¿è¾¼ã¿ä¸­...</div>
                <div id="script-meta" class="script-meta"></div>
                <div id="youtube-info" class="youtube-info"></div>
                <div id="match-info" class="match-info"></div>
            </div>
        </div>

        <!-- ã‚»ãƒªãƒ•ä¸€è¦§ -->
        <div class="dialogues-section">
            <div id="dialogues-header" class="dialogues-header">
                <h3>ã‚»ãƒªãƒ•ä¸€è¦§</h3>
                <div id="dialogues-count" class="dialogues-count"></div>
            </div>
            <div id="dialogues-list" class="dialogues-list">
                <div class="loading">ã‚»ãƒªãƒ•ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const scriptName = getUrlParameter('script_name');
            const keyword = getUrlParameter('keyword');
            
            if (!scriptName) {
                document.getElementById('script-title').textContent = 'ã‚¨ãƒ©ãƒ¼: å°æœ¬åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                return;
            }
            
            loadScriptDetail(scriptName, keyword);
        });

        // å°æœ¬è©³ç´°ã‚’èª­ã¿è¾¼ã¿
        async function loadScriptDetail(scriptName, keyword) {
            try {
                // Netlify Functions ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨
                const apiBase = window.location.hostname.includes('netlify')
                    ? '/.netlify/functions/script_detail'
                    : '/api/script_detail';
                let url = `${apiBase}?script_name=${encodeURIComponent(scriptName)}`;
                if (keyword) {
                    url += `&keyword=${encodeURIComponent(keyword)}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    displayScriptDetail(data.data);
                } else {
                    document.getElementById('script-title').textContent = 'ã‚¨ãƒ©ãƒ¼: ' + data.error;
                }
            } catch (error) {
                console.error('è©³ç´°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('script-title').textContent = 'ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            }
        }

        // å°æœ¬è©³ç´°ã‚’è¡¨ç¤º
        function displayScriptDetail(data) {
            // ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º
            document.getElementById('script-title').textContent = data.script_name;
            document.title = `${data.script_name} - ã‚µãƒ³ã‚µãƒ³ã‚­ãƒƒã‚ºTVå°æœ¬ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆÎ²ç‰ˆï¼‰`;
            
            // ãƒ¡ã‚¿æƒ…å ±è¡¨ç¤º
            const metaHTML = `
                <div class="meta-item">ğŸ“… ${data.release_date || 'ä¸æ˜'}</div>
                <div class="meta-item">ğŸ­ ${data.themes || 'ä¸æ˜'}</div>
                <div class="meta-item">ğŸ“š ${data.subjects || 'ä¸æ˜'}</div>
                ${data.category ? `<div class="meta-item">ğŸ·ï¸ ${data.category}</div>` : ''}
            `;
            document.getElementById('script-meta').innerHTML = metaHTML;
            
            // YouTubeæƒ…å ±è¡¨ç¤º
            if (data.youtube_url && data.youtube_title) {
                const youtubeHTML = `
                    <div class="youtube-card">
                        <div class="youtube-title">ğŸ¬ ${data.youtube_title}</div>
                        <a href="${data.youtube_url}" target="_blank" class="youtube-link">YouTubeã§è¦–è´</a>
                    </div>
                `;
                document.getElementById('youtube-info').innerHTML = youtubeHTML;
            }
            
            // ãƒãƒƒãƒæƒ…å ±è¡¨ç¤º
            if (data.keyword) {
                const confidencePercent = Math.round(data.match_confidence * 100);
                const matchHTML = `
                    <div class="match-stats">
                        <div class="match-item">ğŸ” æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: <strong>"${data.keyword}"</strong></div>
                        <div class="match-item">ğŸ“Š ãƒãƒƒãƒæ•°: <strong>${data.match_count}ä»¶</strong> / å…¨${data.total_dialogues}ä»¶</div>
                        <div class="match-item">ğŸ¯ ãƒãƒƒãƒåº¦: <strong>${confidencePercent}%</strong></div>
                    </div>
                `;
                document.getElementById('match-info').innerHTML = matchHTML;
            }
            
            // ã‚»ãƒªãƒ•ä¸€è¦§è¡¨ç¤º
            displayDialogues(data.dialogues, data.keyword);
        }

        // ã‚»ãƒªãƒ•ä¸€è¦§ã‚’è¡¨ç¤º
        function displayDialogues(dialogues, keyword) {
            const countText = keyword ? 
                `${dialogues.filter(d => d.is_match).length}ä»¶ã®è©²å½“ã‚»ãƒªãƒ•ï¼ˆå…¨${dialogues.length}ä»¶ä¸­ï¼‰` :
                `å…¨${dialogues.length}ä»¶ã®ã‚»ãƒªãƒ•`;
            
            document.getElementById('dialogues-count').textContent = countText;
            
            if (dialogues.length === 0) {
                document.getElementById('dialogues-list').innerHTML = `
                    <div class="no-results">ã‚»ãƒªãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
                `;
                return;
            }
            
            const dialoguesHTML = dialogues.map(dialogue => {
                const matchClass = dialogue.is_match ? 'dialogue-match' : '';
                const highlightedText = keyword && dialogue.is_match ? 
                    dialogue.dialogue.replace(new RegExp(`(${keyword})`, 'gi'), '<mark>$1</mark>') :
                    dialogue.dialogue;
                
                return `
                    <div class="dialogue-card ${matchClass}">
                        <div class="dialogue-header">
                            <span class="dialogue-character">${dialogue.character || 'ä¸æ˜'}</span>
                            <span class="dialogue-row">${dialogue.row_number}è¡Œç›®</span>
                            ${dialogue.is_match ? '<span class="match-badge">ãƒãƒƒãƒ</span>' : ''}
                        </div>
                        <div class="dialogue-text">${highlightedText}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('dialogues-list').innerHTML = dialoguesHTML;
        }
    </script>
</body>
</html>